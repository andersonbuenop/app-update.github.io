<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>SCCM Team</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #333333;
      color: #f0f0f0;
    }
    header {
      padding: 1.5rem 1rem;
      text-align: center;
      background: #f0f0f0;
      border-bottom: 1px solid #c2c2c2;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
      color: #ec0000;
    }
    header p {
      margin: 0.3rem 0 0;
      font-size: 0.9rem;
      color: #333333;
    }
    main {
      padding: 1rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .controls input[type="file"],
    .controls input[type="text"],
    .controls select {
      background: #6d6d6d;
      color: #f0f0f0;
      border: 1px solid #c2c2c2;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .controls input[type="text"] {
      flex: 1 1 200px;
    }
    .controls label {
      font-size: 0.85rem;
      color: #c2c2c2;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #6d6d6d;
      border-radius: 6px;
      overflow: hidden;
      font-size: 0.9rem;
    }
    thead {
      background: #333333;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid #c2c2c2;
      text-align: left;
      white-space: nowrap;
    }
    th {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #c2c2c2;
    }
    tr:nth-child(even) td {
      background: #6d6d6d;
    }
    tr:nth-child(odd) td {
      background: #555555;
    }
    tr:hover td {
      background: #333333;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-button {
      display: inline-flex;
      align-items: center;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .status-button:hover {
      opacity: 0.8;
    }
    .status-button.status-UpdateAvailable {
      background: #f553537a;
      color: #ffffff;
      border: 1px solid #ffffff;
    }
    .status-button.status-UpToDate {
      background: #10b9816c;
      color: #ffffff;
      border: 1px solid #ffffff;
    }
    .status-button.status-Unknown {
      background: #458bfc67;
      color: #ffffff;
      border: 1px solid #ffffff;
    }
    .status-UpdateAvailable {
      background: #ff8a65;
      color: #ffffff;
      border: 1px solid #ff7043;
    }
    .status-UpToDate {
      background: #10b981;
      color: #ffffff;
      border: 1px solid #0f9c6a;
    }
    .status-Unknown {
      background: #458bfc67;
      color: #ffffff;
      border: 1px solid #ffffff;
    }
    a {
      color: #c2c2c2;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      border: 1px solid #c2c2c2;
      padding: 0.1rem 0.6rem;
      font-size: 0.75rem;
      color: #f0f0f0;
      background: #929090;
    }
    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      display: inline-block;
    }
    .dot-update { background: #ff0000; }
    .dot-ok { background: #10b981; }
    .dot-unknown { background: #0c24fc67; }

    /* Badge color accents */
    .badge[data-status="UpdateAvailable"] { border-color: #ffffff; color: #ffffff; }
    .badge[data-status="UpToDate"] { border-color: #ffffff; color: #ffffff; }
    .badge[data-status="Unknown"] { border-color: #ffffff; color: #ffffff; }
    @media (max-width: 768px) {
      th:nth-child(4),
      td:nth-child(4) {
        display: none;
      }
      table {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>SCCM App Status</h1>
  <p>Visualização das applications disponiveis no Software Center, versões instaladas e disponíveis.</p>
</header>

<main>
  <div class="controls">
    <label>
      CSV:
      <input type="file" id="fileInput" accept=".csv,text/csv" />
    </label>
    <input type="text" id="searchInput" placeholder="Filtrar por nome, versão ou status..." />
    <div id="statusBadges" style="display: flex; gap: 0.5rem;">
      <span class="badge" data-status="UpdateAvailable" style="cursor: pointer;">
        <span class="dot dot-update"></span> UpdateAvailable
      </span>
      <span class="badge" data-status="UpToDate" style="cursor: pointer;">
        <span class="dot dot-ok"></span> UpToDate
      </span>
      <span class="badge" data-status="Unknown" style="cursor: pointer;">
        <span class="dot dot-unknown"></span> Unknown
      </span>
    </div>
  </div>

  <div style="overflow-x:auto; max-height: 70vh;">
    <table id="appsTable">
      <thead>
        <tr>
          <th style="width: 50px;">Nº</th>
          <th data-key="AppName">Aplicação</th>
          <th data-key="MergedVersion">Versão Instalada</th>
          <th data-key="LatestVersion">Última Versão Disponível</th>
          <th data-key="License">Licença</th>
          <th data-key="Status">Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas geradas via JS -->
      </tbody>
    </table>
  </div>
</main>

<script>

    function initFromText(text) {
  const { data } = parseCsv(text);
  state.data = data;
  state.filtered = [...state.data];
  renderTable();
}

// tenta carregar apps.csv do mesmo diretório
fetch('apps.csv')
  .then(r => r.ok ? r.text() : Promise.reject())
  .then(text => initFromText(text))
  .catch(() => {
    // fallback para o CSV embutido
    initFromText(defaultCsv);
  });

// CSV embutido como fallback (caso não carregues um ficheiro)
const defaultCsv = `"AppName","appversion","LatestVersion","Website","InstalledVersion","Status"
"7zip 25",,"25.01","https://www.7-zip.org/","25","UpdateAvailable"
"notepad++","8.9","8.9.1","https://notepad-plus-plus.org/downloads/","8.9","UpdateAvailable"
"google chrome","138.3.3.3","144.0.7559.109","https://chromeenterprise.google/intl/pt_br/download/?modal-id=download-chrome","138.3.3.3","UpdateAvailable"
"adobe acrobat reader update","-2345","25.1.21111","https://www.adobe.com/devnet-docs/acrobatetk/tools/ReleaseNotesDC/index.html","2345","UpdateAvailable"
"adobe acrobat 11 pro",,,,,,"Unknown"
"apache directory studio",,,,"https://directory.apache.org/studio/download/",,"Unknown"
"apache cxf",,,,"https://cxf.apache.org/download.html",,"Unknown"
"apache jmeter",,"5.6","https://jmeter.apache.org/download_jmeter.cgi","5.6","UpToDate"
"apache maven",,"3.9.12","https://maven.apache.org/download.cgi","3.9.12","UpToDate"
"ide netbeans",,,,"https://netbeans.apache.org/download/index.html",,"Unknown"`;

// Parser CSV simples, suficiente para este caso
function parseCsv(text) {
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim() !== '');
  const rows = lines.map(line => {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (c === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += c;
      }
    }
    result.push(current);
    return result;
  });

  const headers = rows[0].map(h => h.replace(/^"|"$/g, ''));
  const data = rows.slice(1).map((row, rowIndex) => {
    const obj = { _originalIndex: rowIndex + 1 };
    headers.forEach((h, idx) => {
      obj[h] = (row[idx] || '').replace(/^"|"$/g, '');
    });
    // Calcula versão mesclada para sorting
    const installedVer = parseFloat((obj.InstalledVersion || '0').replace(/[^0-9.]/g, '')) || 0;
    const appVer = parseFloat((obj.appversion || '0').replace(/[^0-9.]/g, '')) || 0;
    const maxVersion = Math.max(installedVer, appVer);
    obj.MergedVersion = maxVersion > 0 ? (obj.InstalledVersion || obj.appversion || '') : '';
    return obj;
  });
  return { headers, data };
}

const state = {
  data: [],
  filtered: [],
  sort: { key: null, dir: 1 },
  statusFilter: null,
  statusDir: 1
};

const tableBody = document.querySelector('#appsTable tbody');
const searchInput = document.getElementById('searchInput');

function statusClass(status) {
  if (!status) return 'status-Unknown';
  return 'status-' + status.replace(/\s+/g, '');
}

function toTitleCase(str) {
  return str.replace(/\b\w/g, char => char.toUpperCase());
}

function renderTable() {
  tableBody.innerHTML = '';
  state.filtered.forEach((row, index) => {
    const tr = document.createElement('tr');

    // Pega a maior versão entre InstalledVersion e appversion
    const installedVer = parseFloat((row.InstalledVersion || '0').replace(/[^0-9.]/g, '')) || 0;
    const appVer = parseFloat((row.appversion || '0').replace(/[^0-9.]/g, '')) || 0;
    const maxVersion = Math.max(installedVer, appVer);
    const mergedVersion = maxVersion > 0 ? (row.InstalledVersion || row.appversion || '') : '';

    // Status como botão com link para website
    let statusButton = `<span class="status-pill ${statusClass(row.Status)}">${row.Status || 'Unknown'}</span>`;
    if (row.Website) {
      statusButton = `<a href="${row.Website}" target="_blank" rel="noopener noreferrer" class="status-button ${statusClass(row.Status)}">${row.Status || 'Unknown'}</a>`;
    }

    tr.innerHTML = `
      <td style="text-align: center; color: #ffffff;">${index + 1}</td>
      <td>${toTitleCase(row.AppName || '')}</td>
      <td>${mergedVersion}</td>
      <td>${row.LatestVersion || ''}</td>
      <td>${(row.License || '').toLowerCase()}</td>
      <td>${statusButton}</td>
    `;
    tableBody.appendChild(tr);
  });
}

function applyFilters() {
  const term = searchInput.value.trim().toLowerCase();
  const status = state.statusFilter;

  state.filtered = state.data.filter(row => {
    const matchesStatus = !status || (row.Status || '') === status;
    const text = (
      (row.AppName || '') + ' ' +
      (row.appversion || '') + ' ' +
      (row.LatestVersion || '') + ' ' +
      (row.Website || '') + ' ' +
      (row.InstalledVersion || '') + ' ' +
      (row.Status || '') + ' ' +
      (row.License || '')
    ).toLowerCase();
    const matchesTerm = !term || text.includes(term);
    return matchesStatus && matchesTerm;
  });

  if (state.sort.key) {
    sortBy(state.sort.key, false);
  } else {
    renderTable();
  }
}

function sortBy(key, toggleDir = true) {
  if (toggleDir) {
    if (state.sort.key === key) {
      state.sort.dir *= -1;
    } else {
      state.sort.key = key;
      state.sort.dir = 1;
    }
  }

  const dir = state.sort.dir;
  state.filtered.sort((a, b) => {
    const va = (a[key] || '').toString().toLowerCase();
    const vb = (b[key] || '').toString().toLowerCase();

    // tenta comparar como número se fizer sentido
    const na = parseFloat(va.replace(/[^0-9.]/g, ''));
    const nb = parseFloat(vb.replace(/[^0-9.]/g, ''));
    const bothNumeric = !isNaN(na) && !isNaN(nb);

    if (bothNumeric) {
      return (na - nb) * dir;
    }
    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  });

  renderTable();
}

// Eventos
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const { data } = parseCsv(ev.target.result);
    state.data = data;
    state.filtered = [...state.data];
    state.sort = { key: null, dir: 1 };
    state.statusFilter = null;
    state.statusDir = 1;
    updateBadgeStyles();
    renderTable();
  };
  reader.readAsText(file, 'utf-8');
});

searchInput.addEventListener('input', applyFilters);

// Badge filter events
document.querySelectorAll('#statusBadges .badge').forEach(badge => {
  badge.addEventListener('click', () => {
    const status = badge.dataset.status;
    
    // Ciclo: neutro -> crescente -> decrescente -> neutro
    if (state.statusFilter === status) {
      if (state.statusDir === 1) {
        state.statusDir = -1;
      } else {
        state.statusFilter = null;
        state.statusDir = 1;
      }
    } else {
      state.statusFilter = status;
      state.statusDir = 1;
    }
    
    updateBadgeStyles();
    applyFilters();
  });
});

function updateBadgeStyles() {
  document.querySelectorAll('#statusBadges .badge').forEach(badge => {
    badge.style.opacity = '0.6';
    badge.innerHTML = badge.innerHTML.replace(' ↓', '').replace(' ↑', '');
    
    if (state.statusFilter === badge.dataset.status) {
      badge.style.opacity = '1';
      const arrow = state.statusDir === 1 ? ' ↓' : ' ↑';
      badge.innerHTML += arrow;
    }
  });
}

document.querySelectorAll('#appsTable thead th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    sortBy(key, true);
  });
});

// Inicializa tentando carregar apps_output.csv, com fallback para defaultCsv
(function init() {
  const loadData = () => {
    fetch('apps_output.csv?t=' + Date.now()) // timestamp para evitar cache
      .then(r => r.ok ? r.text() : Promise.reject())
      .then(text => {
        // Verifica se houve mudança para evitar re-renderizar sem necessidade (opcional, mas bom para UX)
        if (state.lastCsvText !== text) {
            state.lastCsvText = text;
            initFromText(text);
        }
      })
      .catch(() => {
        // Se falhar e ainda não tiver dados carregados, usa o fallback
        if (!state.data || state.data.length === 0) {
            initFromText(defaultCsv);
        }
      });
  };

  // Carrega a primeira vez
  loadData();

  // Polling a cada 5 segundos
  setInterval(loadData, 5000);
})();
</script>
</body>
</html>
