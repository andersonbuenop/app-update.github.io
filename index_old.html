<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>SCCM application Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    header {
      padding: 1.5rem 1rem;
      text-align: center;
      background: #020617;
      border-bottom: 1px solid #1f2937;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header p {
      margin: 0.3rem 0 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }
    main {
      padding: 1rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .controls input[type="file"],
    .controls input[type="text"],
    .controls select {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #374151;
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .controls input[type="text"] {
      flex: 1 1 200px;
    }
    .controls label {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #020617;
      border-radius: 6px;
      overflow: hidden;
      font-size: 0.9rem;
    }
    thead {
      background: #111827;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid #1f2937;
      text-align: left;
      white-space: nowrap;
    }
    th {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #9ca3af;
    }
    tr:nth-child(even) td {
      background: #020617;
    }
    tr:nth-child(odd) td {
      background: #030712;
    }
    tr:hover td {
      background: #111827;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-UpdateAvailable {
      background: rgba(248, 113, 113, 0.15);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.4);
    }
    .status-UpToDate {
      background: rgba(52, 211, 153, 0.15);
      color: #a7f3d0;
      border: 1px solid rgba(52, 211, 153, 0.4);
    }
    .status-Unknown {
      background: rgba(59, 130, 246, 0.15);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.4);
    }
    a {
      color: #60a5fa;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.1rem 0.6rem;
      font-size: 0.75rem;
      color: #9ca3af;
      background: #020617;
    }
    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      display: inline-block;
    }
    .dot-update { background: #f97373; }
    .dot-ok { background: #4ade80; }
    .dot-unknown { background: #60a5fa; }
    @media (max-width: 768px) {
      th:nth-child(2),
      th:nth-child(3),
      th:nth-child(5),
      td:nth-child(2),
      td:nth-child(3),
      td:nth-child(5) {
        display: none;
      }
      table {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>SCCM application Status</h1>
  <p>Visualização do CSV de versões instaladas e disponíveis.</p>
</header>

<main>
  <div class="controls">
    <label>
      CSV:
      <input type="file" id="fileInput" accept=".csv,text/csv" />
    </label>
    <input type="text" id="searchInput" placeholder="Filtrar por nome, versão ou status..." />
    <label>
      Status:
      <select id="statusFilter">
        <option value="">Todos</option>
        <option value="UpdateAvailable">UpdateAvailable</option>
        <option value="UpToDate">UpToDate</option>
        <option value="Unknown">Unknown</option>
      </select>
    </label>
    <span class="badge">
      <span class="dot dot-update"></span> UpdateAvailable
    </span>
    <span class="badge">
      <span class="dot dot-ok"></span> UpToDate
    </span>
    <span class="badge">
      <span class="dot dot-unknown"></span> Unknown
    </span>
  </div>

  <div style="overflow-x:auto; max-height: 70vh;">
    <table id="appsTable">
      <thead>
        <tr>
          <th data-key="AppName">Aplicação</th>
          <th data-key="appversion">AppVersion</th>
          <th data-key="LatestVersion">LatestVersion</th>
          <th data-key="Website">Website</th>
          <th data-key="InstalledVersion">InstalledVersion</th>
          <th data-key="Status">Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas geradas via JS -->
      </tbody>
    </table>
  </div>
</main>

<script>

    function initFromText(text) {
  const { data } = parseCsv(text);
  state.data = data;
  state.filtered = [...state.data];
  renderTable();
}

// tenta carregar apps.csv do mesmo diretório
fetch('apps.csv')
  .then(r => r.ok ? r.text() : Promise.reject())
  .then(text => initFromText(text))
  .catch(() => {
    // fallback para o CSV embutido
    initFromText(defaultCsv);
  });

// CSV embutido como fallback (caso não carregues um ficheiro)
const defaultCsv = `"AppName","appversion","LatestVersion","Website","InstalledVersion","Status"
"7zip 25",,"25.01","https://www.7-zip.org/","25","UpdateAvailable"
"notepad++","8.9","8.9.1","https://notepad-plus-plus.org/downloads/","8.9","UpdateAvailable"
"google chrome","138.3.3.3","144.0.7559.109","https://chromeenterprise.google/intl/pt_br/download/?modal-id=download-chrome","138.3.3.3","UpdateAvailable"
"adobe acrobat reader update","-2345","25.1.21111","https://www.adobe.com/devnet-docs/acrobatetk/tools/ReleaseNotesDC/index.html","2345","UpdateAvailable"
"adobe acrobat 11 pro",,,,,,"Unknown"
"apache directory studio",,,,"https://directory.apache.org/studio/download/",,"Unknown"
"apache cxf",,,,"https://cxf.apache.org/download.html",,"Unknown"
"apache jmeter",,"5.6","https://jmeter.apache.org/download_jmeter.cgi","5.6","UpToDate"
"apache maven",,"3.9.12","https://maven.apache.org/download.cgi","3.9.12","UpToDate"
"ide netbeans",,,,"https://netbeans.apache.org/download/index.html",,"Unknown"`;

// Parser CSV simples, suficiente para este caso
function parseCsv(text) {
  const lines = text.replace(/\r\n/g, '\n').split('\n').filter(l => l.trim() !== '');
  const rows = lines.map(line => {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (c === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += c;
      }
    }
    result.push(current);
    return result;
  });

  const headers = rows[0].map(h => h.replace(/^"|"$/g, ''));
  const data = rows.slice(1).map(row => {
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = (row[idx] || '').replace(/^"|"$/g, '');
    });
    return obj;
  });
  return { headers, data };
}

const state = {
  data: [],
  filtered: [],
  sort: { key: null, dir: 1 }
};

const tableBody = document.querySelector('#appsTable tbody');
const searchInput = document.getElementById('searchInput');
const statusFilter = document.getElementById('statusFilter');

function statusClass(status) {
  if (!status) return 'status-Unknown';
  return 'status-' + status.replace(/\s+/g, '');
}

function renderTable() {
  tableBody.innerHTML = '';
  state.filtered.forEach(row => {
    const tr = document.createElement('tr');

    const websiteLink = row.Website ? `<a href="${row.Website}" target="_blank" rel="noopener noreferrer">link</a>` : '';

    tr.innerHTML = `
      <td>${row.AppName || ''}</td>
      <td>${row.appversion || ''}</td>
      <td>${row.LatestVersion || ''}</td>
      <td>${websiteLink}</td>
      <td>${row.InstalledVersion || ''}</td>
      <td>
        <span class="status-pill ${statusClass(row.Status)}">
          ${row.Status || 'Unknown'}
        </span>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

function applyFilters() {
  const term = searchInput.value.trim().toLowerCase();
  const status = statusFilter.value;

  state.filtered = state.data.filter(row => {
    const matchesStatus = !status || (row.Status || '') === status;
    const text = (
      (row.AppName || '') + ' ' +
      (row.appversion || '') + ' ' +
      (row.LatestVersion || '') + ' ' +
      (row.Website || '') + ' ' +
      (row.InstalledVersion || '') + ' ' +
      (row.Status || '')
    ).toLowerCase();
    const matchesTerm = !term || text.includes(term);
    return matchesStatus && matchesTerm;
  });

  if (state.sort.key) {
    sortBy(state.sort.key, false);
  } else {
    renderTable();
  }
}

function sortBy(key, toggleDir = true) {
  if (toggleDir) {
    if (state.sort.key === key) {
      state.sort.dir *= -1;
    } else {
      state.sort.key = key;
      state.sort.dir = 1;
    }
  }

  const dir = state.sort.dir;
  state.filtered.sort((a, b) => {
    const va = (a[key] || '').toString().toLowerCase();
    const vb = (b[key] || '').toString().toLowerCase();

    // tenta comparar como número se fizer sentido
    const na = parseFloat(va.replace(/[^0-9.]/g, ''));
    const nb = parseFloat(vb.replace(/[^0-9.]/g, ''));
    const bothNumeric = !isNaN(na) && !isNaN(nb);

    if (bothNumeric) {
      return (na - nb) * dir;
    }
    if (va < vb) return -1 * dir;
    if (va > vb) return 1 * dir;
    return 0;
  });

  renderTable();
}

// Eventos
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const { data } = parseCsv(ev.target.result);
    state.data = data;
    state.filtered = [...state.data];
    state.sort = { key: null, dir: 1 };
    renderTable();
  };
  reader.readAsText(file, 'utf-8');
});

searchInput.addEventListener('input', applyFilters);
statusFilter.addEventListener('change', applyFilters);

document.querySelectorAll('#appsTable thead th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    sortBy(key, true);
  });
});

// Inicializa com o CSV default
(function init() {
  const { data } = parseCsv(defaultCsv);
  state.data = data;
  state.filtered = [...state.data];
  renderTable();
})();
</script>
</body>
</html>
